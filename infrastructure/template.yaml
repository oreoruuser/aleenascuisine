AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AleenasCuisine Application (Full Playbook A-G, Final Version)

Conditions:
  HasLambdaExecutionRoleArn: !Not [ !Equals [ !Ref LambdaExecutionRoleArn, "" ] ]
  HasKeyAdminArn: !And
    - !Not [ !Equals [ !Ref KeyAdminArn, "" ] ]
    - !Not [ !Equals [ !Ref KeyAdminArn, "NONE" ] ]

# ===============================================
# 1. PARAMETERS (STEP A)
# ===============================================
Parameters:
  Env:
    Type: String
    Default: dev
    Description: The environment name (dev or prod).

  AppPrefix:
    Type: String
    Default: aleenascuisine-dev
    Description: The prefix for all resources (e.g., aleenascuisine-dev).

  LambdaExecutionRoleArn:
    Type: String
    Default: ""
    Description: ARN of the pre-provisioned Lambda execution role with least-privilege access.

  NotificationEmail:
    Type: String
    Default: matkevin00@gmail.com
    Description: Email address for operational alerts and budget notifications.

  ApiAllowedOrigin:
    Type: String
    Default: http://localhost:3000
    Description: Allowed origin for CORS on the API Gateway stage.

  MonthlyBudgetAmount:
    Type: Number
    Default: 30
    Description: Monthly AWS cost budget threshold in USD.

  KeyAdminArn:
    Type: String
    Default: ""
    Description: IAM principal ARN granted administrative control of the CMK (set to NONE to skip dedicated admin access).

# ===============================================
# 2. GLOBALS (STEP A)
# ===============================================
Globals:
  Function:
    Runtime: python3.12
    Timeout: 30
    Architectures:
      - arm64
    Tags:
      Project: aleenascuisine
      Owner: kevinMathew
      CostCenter: cseproj
      Env: !Ref Env
    VpcConfig:
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
      SecurityGroupIds:
        - !Ref LambdaSecurityGroup

# ===============================================
# 3. RESOURCES
# ===============================================
Resources:

  ##################################################
  # A. APPLICATION, AUTH & API
  ##################################################

  # --- This Log Group must be defined *before* the API that uses it ---
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/api-gateway/${AppPrefix}-api"
      RetentionInDays: 7
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  ApiGatewayCloudWatchRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppPrefix}-apigw-logs"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  ApiGatewayAccount:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !GetAtt ApiGatewayCloudWatchRole.Arn

  AleenasCuisineApi:
    Type: AWS::Serverless::Api
    DependsOn:
      - ApiGatewayAccount
    Properties:
      Name: !Sub "${AppPrefix}-api"
      StageName: !Ref Env
      Cors:
        AllowOrigin: !Sub "'${ApiAllowedOrigin}'"
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization'"
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          MetricsEnabled: true
          LoggingLevel: INFO
          ThrottlingRateLimit: 20
          ThrottlingBurstLimit: 60
      TracingEnabled: true
      Tags:
        Project: aleenascuisine
        Owner: kevinMathew
        CostCenter: cseproj
        Env: !Ref Env

  ApiUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    DependsOn:
      - AleenasCuisineApiStage
    Properties:
      UsagePlanName: !Sub "${AppPrefix}-${Env}-default"
      Description: Baseline throttling profile for the ${Env} stage.
      Throttle:
        BurstLimit: 60
        RateLimit: 20
      Quota:
        Limit: 100000
        Period: MONTH
      ApiStages:
        - ApiId: !Ref AleenasCuisineApi
          Stage: !Ref Env
      Tags:
        - Key: Project
          Value: aleenascuisine
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Env
          Value: !Ref Env

  ApiKey:
    Type: AWS::ApiGateway::ApiKey
    DependsOn:
      - AleenasCuisineApiStage
    Properties:
      Name: !Sub "${AppPrefix}-${Env}-default-key"
      Enabled: true
      StageKeys:
        - RestApiId: !Ref AleenasCuisineApi
          StageName: !Ref Env
      Tags:
        - Key: Project
          Value: aleenascuisine
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Env
          Value: !Ref Env

  UsagePlanKeyAssociation:
    Type: AWS::ApiGateway::UsagePlanKey
    DependsOn:
      - ApiUsagePlan
      - ApiKey
    Properties:
      KeyId: !Ref ApiKey
      KeyType: API_KEY
      UsagePlanId: !Ref ApiUsagePlan

  # --- This Log Group must be defined *before* the Function and Filters that use it ---
  FastApiAppFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppPrefix}-app"
      RetentionInDays: 7
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  FastApiAppFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AppPrefix}-app"
      CodeUri: ../backend/app/
      Handler: main.handler
      Tracing: Active
      Events:
        ApiProxy:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
            RestApiId: !Ref AleenasCuisineApi
      Role: !Ref LambdaExecutionRoleArn
    DependsOn: FastApiAppFunctionLogGroup

  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "${AppPrefix}-user-pool"
      UserPoolTags:
        Project: aleenascuisine
        Owner: kevinMathew
        CostCenter: cseproj
        Env: !Ref Env

  ##################################################
  # B. NETWORKING (VPC, SUBNETS, NAT, ENDPOINTS)
  ##################################################

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Ref AppPrefix
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  # --- Public Subnets, NAT, and Routing ---
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.100.0/24
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AppPrefix}-public-a"
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.101.0/24
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${AppPrefix}-public-b"
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Ref AppPrefix
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  NatEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub "${AppPrefix}-nat-eip"
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIP.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
        - Key: Name
          Value: !Sub "${AppPrefix}-nat"
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AppPrefix}-rt-public"
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine
  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  PublicSubnetARouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnetA
  PublicSubnetBRouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnetB

  # --- Private Subnets and Routing ---
  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: !Sub "${AppPrefix}-private-a"
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: !Sub "${AppPrefix}-private-b"
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AppPrefix}-rt-private"
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine
  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway
  PrivateSubnetARouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnetA
  PrivateSubnetBRouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnetB

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: DB subnet group for aleenascuisine
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  # --- Security Groups ---
  EndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${AppPrefix}-endpoint-sg"
      GroupDescription: "Security group for VPC Interface Endpoints"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${AppPrefix}-lambda-sg"
      GroupDescription: "Security group for Lambda function"
      VpcId: !Ref VPC
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub "${AppPrefix}-db-sg"
      GroupDescription: "Security group for Aurora DB"
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref EndpointSecurityGroup
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  # --- VPC Endpoints ---
  S3GatewayEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      RouteTableIds:
        - !Ref PrivateRouteTable

  SecretsManagerEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.secretsmanager"
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
      SecurityGroupIds:
        - !Ref EndpointSecurityGroup
      Tags: # <-- TAGS ARE NOW FIXED
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  RdsDataEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.rds-data"
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
      SecurityGroupIds:
        - !Ref EndpointSecurityGroup
      Tags: # <-- TAGS ARE NOW FIXED
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  LogsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.logs"
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
      SecurityGroupIds:
        - !Ref EndpointSecurityGroup
      Tags: # <-- TAGS ARE NOW FIXED
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  RdsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.rds"
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnetA
        - !Ref PrivateSubnetB
      SecurityGroupIds:
        - !Ref EndpointSecurityGroup
      Tags: # <-- TAGS ARE NOW FIXED
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  ##################################################
  # C. DATABASE
  ##################################################

  DBParameterGroup:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      Description: "Cluster parameter group for aleenascuisine"
      Family: aurora-mysql8.0
      Parameters:
        time_zone: "UTC"
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  RDSMonitoringRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppPrefix}-rds-monitoring-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: monitoring.rds.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  AuroraCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DBClusterIdentifier: !Sub "${AppPrefix}-aurora"
      DatabaseName: aleenascuisine
      Engine: aurora-mysql
      DBClusterParameterGroupName: !Ref DBParameterGroup
      EnableHttpEndpoint: true
      MasterUsername: !Sub '{{resolve:secretsmanager:${DBSecret}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DBSecret}:SecretString:password}}'
      StorageEncrypted: true
      KmsKeyId: !Ref KmsKey
      BackupRetentionPeriod: 7
      AutoMinorVersionUpgrade: true
      PreferredMaintenanceWindow: "sun:19:00-sun:19:30"
      MonitoringInterval: 60
      MonitoringRoleArn: !GetAtt RDSMonitoringRole.Arn
      ServerlessV2ScalingConfiguration:
        MinCapacity: 0.0
        MaxCapacity: 2.0
      DBSubnetGroupName: !Ref DBSubnetGroup
      VpcSecurityGroupIds:
        - !Ref DBSecurityGroup
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  AuroraClusterInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub "${AppPrefix}-aurora-instance-1"
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.serverless
      Engine: aurora-mysql
      PubliclyAccessible: false
      EnablePerformanceInsights: true
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  ##################################################
  # D. SECRETS & KEYS
  ##################################################
  KmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub "KMS key for ${AppPrefix}"
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Allow-Root-Admin
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - !If
            - HasKeyAdminArn
            - Sid: Allow-Key-Admin
              Effect: Allow
              Principal:
                AWS: !Ref KeyAdminArn
              Action:
                - kms:Describe*
                - kms:List*
                - kms:Get*
                - kms:Create*
                - kms:Update*
                - kms:Enable*
                - kms:Disable*
                - kms:ScheduleKeyDeletion
                - kms:CancelKeyDeletion
              Resource: "*"
            - !Ref AWS::NoValue
          - Sid: Allow-Lambda-Use
            Effect: Allow
            Principal:
              AWS: !If [HasLambdaExecutionRoleArn, !Ref LambdaExecutionRoleArn, !Sub "arn:aws:iam::${AWS::AccountId}:root"]
            Action:
              - kms:Decrypt
              - kms:Encrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: "*"
          - Sid: Allow-Secrets-Manager-Use
            Effect: Allow
            Principal:
              Service: secretsmanager.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: "*"
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  KmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AppPrefix}-key"
      TargetKeyId: !Ref KmsKey

  RazorpaySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AppPrefix}/razorpay"
      Description: "Razorpay API keys for aleenascuisine"
      SecretString: '{"key_id": "REPLACE_ME", "key_secret": "REPLACE_ME"}'
      KmsKeyId: !Ref KmsKey
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AppPrefix}/db"
      Description: "Database master credentials for aleenascuisine"
      KmsKeyId: !Ref KmsKey
      GenerateSecretString:
        SecretStringTemplate: '{"username": "admin"}'
        GenerateStringKey: "password"
        PasswordLength: 16
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  ##################################################
  # E. STORAGE (S3) & CDN
  ##################################################

  ImagesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AppPrefix}-images"
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: aleenascuisine
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: MoveToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 365
                StorageClass: GLACIER

  ImagesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ImagesBucket
      PolicyDocument:
        Statement:
          - Action: s3:GetObject
            Effect: Allow
            Resource: !Sub "arn:aws:s3:::${AppPrefix}-images/*"
            Principal:
              Service: cloudfront.amazonaws.com
            Condition:
              StringEquals:
                "AWS:SourceArn": !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

  InvoicesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AppPrefix}-invoices"
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: aleenascuisine
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: MoveToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 365
                StorageClass: GLACIER

  CloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${AppPrefix}-oac-s3"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Origins:
          - DomainName: !GetAtt ImagesBucket.RegionalDomainName
            Id: S3-aleenascuisine-images
            OriginAccessControlId: !GetAtt CloudFrontOriginAccessControl.Id
            S3OriginConfig:
              OriginAccessIdentity: ""
        DefaultCacheBehavior:
          TargetOriginId: S3-aleenascuisine-images
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  ##################################################
  # G. OBSERVABILITY & MONITORING
  ##################################################

  AlarmsSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: !Sub "${AppPrefix}-alarms"
      Subscription:
        - Endpoint: !Ref NotificationEmail
          Protocol: email
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  ErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref FastApiAppFunctionLogGroup
      FilterPattern: "ERROR"
      MetricTransformations:
        - MetricName: !Sub "${AppPrefix}-lambda-errors-logged"
          MetricNamespace: "AleenasCuisine/Logs"
          MetricValue: "1"
    DependsOn: FastApiAppFunctionLogGroup

  WarningMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref FastApiAppFunctionLogGroup
      FilterPattern: "WARNING"
      MetricTransformations:
        - MetricName: !Sub "${AppPrefix}-lambda-warnings-logged" # <-- TYPO IS FIXED HERE
          MetricNamespace: "AleenasCuisine/Logs"
          MetricValue: "1"
    DependsOn: FastApiAppFunctionLogGroup

  CloudWatchDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${AppPrefix}-Dashboard"
      DashboardBody: !Sub
        - |
          {
            "widgets": [
              {
                "type": "metric",
                "x": 0, "y": 0, "width": 12, "height": 6,
                "properties": {
                  "metrics": [
                    ["AWS::Lambda", "Errors", "FunctionName", "${LambdaName}", {"label": "Lambda Errors"}],
                    [".", "Invocations", ".", ".", {"label": "Lambda Invocations"}]
                  ],
                  "period": 300, "stat": "Sum", "region": "${AWS::Region}", "title": "Lambda Function Health"
                }
              },
              {
                "type": "metric",
                "x": 12, "y": 0, "width": 12, "height": 6,
                "properties": {
                  "metrics": [
                    ["AWS/ApiGateway", "5xx", "ApiId", "${ApiId}", {"label": "API 5xx Errors"}],
                    [".", "4xx", ".", ".", {"label": "API 4xx Errors"}]
                  ],
                  "period": 300, "stat": "Sum", "region": "${AWS::Region}", "title": "API Gateway Health"
                }
              },
              {
                "type": "metric",
                "x": 0, "y": 6, "width": 12, "height": 6,
                "properties": {
                  "metrics": [
                    ["AWS/RDS", "ServerlessDatabaseCapacity", "DBClusterIdentifier", "${DbClusterId}", {"label": "Aurora ACU"}]
                  ],
                  "period": 300, "stat": "Average", "region": "${AWS::Region}", "title": "Database ACU Usage"
                }
              }
            ]
          }
        - LambdaName: !Ref FastApiAppFunction
          ApiId: !Ref AleenasCuisineApi
          DbClusterId: !Ref AuroraCluster

  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AppPrefix}-Lambda-Errors"
      AlarmDescription: "Alarm if Lambda error rate exceeds 1% in 5 minutes"
      MetricName: "Errors"
      Namespace: "AWS/Lambda"
      Dimensions:
        - Name: FunctionName
          Value: !Ref FastApiAppFunction
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      TreatMissingData: "notBreaching"
      AlarmActions: [ !Ref AlarmsSNSTopic ]
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  ApiGateway5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AppPrefix}-API-5xx-Errors"
      AlarmDescription: "Alarm if API Gateway 5xx errors spike"
      MetricName: "5xx"
      Namespace: "AWS/ApiGateway"
      Dimensions:
        - Name: ApiId
          Value: !Ref AleenasCuisineApi
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      TreatMissingData: "notBreaching"
      AlarmActions: [ !Ref AlarmsSNSTopic ]
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  AuroraAcuAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AppPrefix}-Aurora-ACU-High"
      AlarmDescription: "Alarm if Aurora ACU usage is over 75% of max"
      MetricName: "ServerlessDatabaseCapacity"
      Namespace: "AWS/RDS"
      Dimensions:
        - Name: DBClusterIdentifier
          Value: !Ref AuroraCluster
      Statistic: "Average"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1.5
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      TreatMissingData: "notBreaching"
      AlarmActions: [ !Ref AlarmsSNSTopic ]
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  SecretsManagerAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AppPrefix}-Secrets-Access-Errors"
      AlarmDescription: "Alarm on any Secrets Manager access error"
      MetricName: "GetSecretValue.Failed"
      Namespace: "AWS/SecretsManager"
      Statistic: "Sum"
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: "GreaterThanOrEqualToThreshold"
      TreatMissingData: "notBreaching"
      AlarmActions: [ !Ref AlarmsSNSTopic ]
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Owner
          Value: kevinMathew
        - Key: CostCenter
          Value: cseproj
        - Key: Project
          Value: aleenascuisine

  MonthlyCostBudget:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Sub "${AppPrefix}-${Env}-monthly-budget"
        BudgetLimit:
          Amount: !Ref MonthlyBudgetAmount
          Unit: USD
        TimeUnit: MONTHLY
        BudgetType: COST
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            ThresholdType: PERCENTAGE
            Threshold: 50
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref NotificationEmail
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            ThresholdType: PERCENTAGE
            Threshold: 80
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref NotificationEmail
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            ThresholdType: PERCENTAGE
            Threshold: 100
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref NotificationEmail
